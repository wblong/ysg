<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <title>洋山港</title>
    <!--bootstrap-->
    <link rel="stylesheet" href="dist/bootstrap.min.css">
     <!--ol-->
    <link rel="stylesheet" href="dist/ol.min.css">
    <!--ol-editor-->
    <link rel="stylesheet" href="dist/ol.editor.css">
    <!--ol-ex-search-->
	<link rel="stylesheet"  href="dist/ex/control/searchcontrol.css">
	<!--ol-ex-overlay-->
	<link rel="stylesheet"  href="dist/ex/control/popupoverlay.css">
	<link rel="stylesheet"  href="dist/ex/control/popupoverlay.anim.css">
	
    <!--custom css-->
    <link rel="stylesheet" type="text/css" href="dist/custom.css">
    <link rel="shortcut icon" href="favicon.ico">
    <!---->
    <link href="dist/bootstrap/css/bootstrap-datetimepicker.min.css" rel="stylesheet">
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" href="dist/ex/control/layerpopupcontrol.css">
    <link rel="stylesheet" type="text/css" href="dist/ex/control/controlbar.css">
    	<!-- 脚本 -->
        <!--jquery-->
        <script src="dist/jquery.min.js"></script>
		<!--左侧UI-->
		<link rel="stylesheet" type="text/css" href="dist/left_tab.css">
        <script type="text/javascript" src="dist/left_tab.js"></script>
		<!--上侧按钮-->
		<link rel="stylesheet" type="text/css" href="dist/tab_btn.css">
		<script type="text/javascript" src="dist/tab_btn.js"></script>


    	<script src="dist/bootstrap.min.js"></script>
        <!--proj4-->
        <script src="dist/proj4.js"></script>
        <!--ol-->
        <script src="dist/ol-debug.js"></script>
       
        <!--ol-ex-->
    	<script src="dist/ex/control/searchcontrol.js"></script>
    	<script src="dist/ex/control/searchfeaturecontrol.js"></script>
    	<script src="dist/ex/control/popupoverlay.js"></script>
    	<script type="text/javascript" src="dist/ex/control/layerswitchercontrol.js"></script>
    	<script type="text/javascript" src="dist/ex/control/layerpopupcontrol.js"></script>
    	<script type="text/javascript" src="dist/ex/control/controlbar.js"></script>
    	<script type="text/javascript" src="dist/ex/control/buttoncontrol.js"></script>
    	<script type="text/javascript" src="dist/ex/control/togglecontrol.js"></script>

    	 <!--ol-editor-->
        <script src="dist/ol.editor.js"></script>
    	<!--video-->
    	<script src="dist/ex/control/videoPopupOverlay.js"></script>
    	<!--style-->
        <script src="dist/styles.js"></script>
        <!--mq-->
        <script src="dist/rabbitmq/sockjs-0.3.js"></script>
        <script src="dist/rabbitmq/stomp.js"></script>
        <!--bootstrap-->
        <script src="dist/bootstrap/js/bootstrap-datetimepicker.min.js"></script>
        <script src="dist/bootstrap/js/locales/bootstrap-datetimepicker.zh-CN.js"></script>

       
  </head>
  <body>
  	<!-- <iframe src="http://localhost:1886/Scripts/selection/jsp/Selection.html" z-index=1000></iframe> -->
    <div class="application">
    	<!--菜单栏-->
		<!-- <div id="menubar" class="menubar">
				<ul>
					<li class="active"><a href="#maptools" role="tab" data-toggle="tab"><img src="res/tools.png"></a></li>
					<li><a href="#equipments" role="tab" data-toggle="tab"><img src="res/print.png"></a></li>
				</ul>
		</div>
		
		<div id="toolbar" class="toolbar tab-content pinned">
			<div id="maptools" class="tab-pane active showing"></div>
			<div id="equipments" class="tab-pane">
			</div>
		</div> -->
		<!--地图容器-->
		<div class="map-container">
			<!--图层管理器-->
			<div id="layermanager" class="layermanager">
       		 	<div class="bar-title"><!-- <a href="#layermanager" class="pin active" title="Pin/unpin layer manager"><i class="glyphicon glyphicon-pushpin"></i></a> --> 图层管理</div>
    		</div>
    		<div id="tab-btn">
    			<ul class="first">
    				<li> <a href="#"><img src="res/measure-tools.png"></a>
						<ul class="second">
							<li><a href="#">长度</a></li>
							<li><a href="#">面积</a></li>
							<li><a href="#">角度</a></li>
						</ul>
    				</li>
	    			
    			</ul>
    		</div>
    		<div id="tab-query">
    			<ul class="first">
				  <li> 
					   <a href="#">目录A</a>
					   <ul class="second">
							<li><a  href="##">二级目录A</a>
								<div class="content">
									<p>姓名：张三</p>
									<p>驾照：3333333</p>
									<p>手机:182333333</p>
									<p>desc:tesgghaglafahidfidfdifhdifhdif djfhdfdif
									  hdifhdifhdi fidfhidi dhfdihdfhdihidfhdihihdi</p>
					  			</div>	
							</li>
							<li><a  href="##">二级目录B</a>
										<div class="content">
											<p>姓名：张三</p>
											<p>驾照：3333333</p>
											<p>手机:182333333</p>
											<p>desc:tesgghaglafahidfidfdifhdifhdif djfhdfdif
											  hdifhdifhdi fidfhidi dhfdihdfhdihidfhdihihdi</p>
							  			</div>	
							</li>
					   </ul>
				  </li>
				  <li> 
					   <a href="#">目录B</a>
					   <ul class="second">
							<li><a  href="##">二级目录A</a>
								<div class="content">
									<p>姓名：张三</p>
									<p>驾照：3333333</p>
									<p>手机:182333333</p>
									<p>desc:tesgghaglafahidfidfdifhdifhdif djfhdfdif
									  hdifhdifhdi fidfhidi dhfdihdfhdihidfhdihihdi</p>
					  			</div>			
							</li>
							<li><a  href="##">二级目录B</a>	
								<div class="content">
									<p>姓名：李四</p>
									<p>驾照：3333333</p>
									<p>手机:182333333</p>
									<p>desc:tesgghaglafahidfidfdifhdifhdif djfhdfdif
									  hdifhdifhdi fidfhidi dhfdihdfhdihidfhdihihdi</p>
					  			</div>	
							</li>
					   </ul>
				  </li>
    			</ul>
    		</div>
    		<!--属性管理器-->
			<!-- <div id="attributemanager" class="attributemanager">
        		<div class="bar-title"><a href="#attributemanager" class="pin" title="Pin/unpin attribute manager"><i class="glyphicon glyphicon-pushpin"></i></a> 属性管理</div>
    		</div> -->
    		<!-- 地图 -->
			<div id="map" class="map" tabindex="-1" style="cursor:default"></div>
			
		</div>
		<!-- 状态栏 -->
     	<div id="statusbar" class="statusbar"></div>
     	<!--查询条件对话框-->
     	<div id="querydlg" class="modal fade" role='dialog' tabindex="-1">
     		<div class="modal-dialog">
				<div class="modal-content">
					<form id='queryform'>
						<!-- <div class="modal-header">
							<button type="button" class="close" data-dismiss='modal'>&times;</button>
							<h4 class="modal-title"></h4>
						</div> -->
						<div class="modal-body">
							<div class="form-horizontal">
								<div class="form-group">
									 <label class="control-label input-sm col-sm-3">开始时间:</label>
									 <div class="col-sm-8 input-append date form_datetime">
										<input type="text" name="start_time"  class="form-control input-sm" value="" readonly="">
										<span class="add-on"><i class="icon-th"></i></span>
									 </div>
								</div>
								<div class="form-group">
									 <label class="control-label input-sm col-sm-3">结束时间:</label>
									  <div class="col-sm-8 input-append date form_datetime">
									 	<input type="text" name="end_time"  class="form-control input-sm" value="" readonly="">
									 	<span class="add-on"><i class="icon-th"></i></span>
									  </div>
								</div>
								<div class="checkbox">
									<div class="form-group">
										<label class="control-label input-sm col-sm-3">
										<input type="checkbox"  name="camera">摄像机</label>
										<label class="control-label input-sm col-sm-3">
										<input type="checkbox"  name="jika">集卡</label>
										<label class="control-label input-sm col-sm-3">
										<input type="checkbox"  name="agv"> AGV</label>
									</div>
									<div class="form-group">
										<label class="control-label input-sm col-sm-3">
										<input type="checkbox"  name="ldiao">龙门吊</label>
										<label class="control-label input-sm col-sm-3">
										<input type="checkbox"  name="qdiao">桥吊</label>
										<label class="control-label input-sm col-sm-3">
										<input type="checkbox"  name="gdiao">轨道吊</label>
									</div>
									<div class="form-group">
										<label class="control-label input-sm col-sm-3">
										<input type="checkbox"  name="tirediao">轮胎吊</label>
										<label class="control-label input-sm col-sm-3">
										<input type="checkbox"  name="qiuji">球机</label>
										<label class="control-label input-sm col-sm-3">
										<input type="checkbox"  name="qiangji">枪机</label>
										
									</div>
								</div>
							</div>
						</div>
						<div class="modal-footer">
							<button type="submit" class="btn btn-sm btn-primary">确定</button>
							<button type="button" class="btn btn-sm btn-default" data-dismiss="modal">取消</button>
						</div>
					</form>
				</div>
     		</div>
     	</div>
    </div>
	
	<script>
		styleFunction=function(feature,resolution){
			var zoom=editor.getView().getZoom();
			var style=null;
			var properties=feature.getProperties();
			if(properties.type===1){
				
				style=styles['car'];
			}
			else if(properties.type===2){
				style=styles['camera'];
			}
			else if (properties.type===3) {
				style=styles['agv'];
			}
			else if (properties.type===4) {
				style=styles['qdiao'];
			}
			else if (properties.type===5) {
				style=styles['gdiao'];
			}
			else if (properties.type===6) {
				style=styles['ldiao'];
			}
			else if (properties.type===7) {
				style=styles['alarm'];
			}
			else if (properties.type===8) {
				style=styles['pos'];
			}
			else{
				style=styles['pos'];
			}
			if (zoom===12) {
				return [styles['point']];
			}
			else{
				style.getImage().setScale(zoom/25);
				return [style];
			}
			
		};
		//选择
		var selectClick=new ol.interaction.Select({
			
		});
		
	     var attributeManager=new ol.control.AttributeManager({ target: 'attributemanager' });
	     //attributeManager.setMap(map);
	    // proj4.defs("EPSG:23700","+title=HD72 EOV +proj=somerc +lat_0=47.14439372222222 +lon_0=19.04857177777778 +k_0=0.99993 +x_0=650000 +y_0=200000 +ellps=GRS67 +towgs84=52.17,-71.82,-14.9,0,0,0,0 +units=m +no_defs");
	    var eov = new ol.proj.Projection({
	        code: 'EPSG:3857',
	        extent: [13582066.888853556, 3587359.445355572,
                    13585173.06488047, 3588705.080676691],
	        worldExtent: [73,3, 135, 53]
	    });
	   

	    //地图设置
	    //动态图层
	    var realTimeLayer=new ol.layer.Vector({
	    	name:'动态图层',
	    	source:new ol.source.Vector({
                    url:"data/ldiao.geojson",
                    format:new ol.format.GeoJSON()}),
	    	style:styleFunction
	    });
	    realTimeLayer.set('type','geomcollection');
	    realTimeLayer.set('id','realTimeLayerID');

	    //search
	    var search = new ol.control.SearchFeature(
		{	
			//target: $("#search").get(0),
			source: realTimeLayer.getSource(),//设置查询的图层
			property: 'id'
		});
		// Popup overlay
		var popup = new ol.Overlay.Popup (
		{	popupClass: "default", //"tooltips", "warning" "black" "default", "tips", "shadow",
			closeBox: true,
			onclose: function(){ console.log("关闭窗口!"); },
			positioning: 'auto',
			autoPan: true,
			autoPanAnimation: { duration: 100 },
			id:'1'
		});
		// map
	    editor = new ol.Editor({
	    	overlays:[popup],

	        target: 'map',
	        view: new ol.View({
	            //projection: 'EPSG:4326',
	            extent: [13582065, 3587358,13585174, 3588706],
	            center: [13583806.359,3588119.431],
	            zoom: 14,
	            minZoom: 12,
                maxZoom: 23,
                rotation:-15*Math.PI/180.0
	        }),
	        layers: [
	            new ol.layer.Tile({
	                name: 'OpenStreetMap',
	                source: new ol.source.OSM()
	            }),
	        //     new ol.layer.Tile({
	        // 		visible: false,
	        // 		name:'ysg-tile',
	        // 		source: new ol.source.TileWMS({
	        //   			url: 'http://localhost:8080/geoserver/ysg/wms',
			      //     params: {'FORMAT': 'image/png', 
			      //              'VERSION': '1.1.1',
			      //              tiled: true,
			      //           STYLES: '',
			      //           LAYERS: 'ysg:jizhuangxiang',
			      //        tilesOrigin: 13582132.823772825 + "," + 3587341.8755370886
			      //     }
			      //   })
			      // }),
	            new ol.layer.Image({
	            	name:'洋山港-边界',
					source: new ol.source.ImageWMS({
						url: 'http://192.168.5.239:8080/geoserver/ysg/wms',
						params: {'LAYERS': 'ysg:bianjie1','VERSION':'1.1.0'},
						serverType: 'geoserver',
	         	 })
				}),
				 new ol.layer.Image({
	            	name:'洋山港-集装箱',
					source: new ol.source.ImageWMS({
						url: 'http://192.168.5.239:8080/geoserver/ysg/wms',
						params: {'LAYERS': 'ysg:jizhuangxiang','VERSION':'1.1.0'},
						serverType: 'geoserver',
	         	 })
				}),
				  new ol.layer.Image({
	            	name:'洋山港-道路',
					source: new ol.source.ImageWMS({
						url: 'http://192.168.5.239:8080/geoserver/ysg/wms',
						params: {'LAYERS': 'ysg:road','VERSION':'1.1.0'},
						serverType: 'geoserver',
	         	 })
				}),
				   new ol.layer.Image({
	            	name:'洋山港-设备',
					source: new ol.source.ImageWMS({
						url: 'http://192.168.5.239:8080/geoserver/ysg/wms',
						params: {'LAYERS': 'ysg:shebei','VERSION':'1.1.0'},
						serverType: 'geoserver',
	         	 })
				}),
				realTimeLayer
	        ],
	        //地图控件加载
	        
	        controls: [
	        	//new ol.control.Add({target:'ysgceshi',tipLabel:'相机标定'}),
	        	//new ol.control.LayerPopup(),
	        	new ol.control.Exit(),
	        	new ol.control.Condition(),
	        	//new ol.control.FullScreen(),
	            new ol.control.Rotate(),
	            new ol.control.ScaleLine(),
	            new ol.control.ZoomSlider(),
	            //new ol.control.Attribution({ collapsible: false }),
	            new ol.control.LayerManager({ target: 'layermanager' }),
	            attributeManager,
	           // new ol.control.Zoom({ target: 'maptools',zoomOutLabel:'', zoomInTipLabel:'放大',zoomOutTipLabel:'缩小' }),
	           // new ol.control.ZoomHistory({ target: 'maptools' , backTipLabel:'向前',nextTipLabel:'向后'}), 
	           // new ol.control.ZoomToExtent({ target: 'maptools', label: ' ',tipLabel:'全局' ,extent: eov.getExtent()}),
	           // new ol.control.ZoomToSelection({ target: 'maptools' }),
	           // new ol.control.SelectionControls({ target: 'maptools' }),
	           // new ol.control.Measure({ target: 'measure_tools' }),
	            new ol.control.Message({ target: 'statusbar' }),
	            new ol.control.QueryField({target:'statusbar'}),
	            new ol.control.MousePosition({
	                target: 'statusbar',
	                className: 'ol-mouse-position ol-control ol-unselectable',
	                coordinateFormat: ol.coordinate.createStringXY(3)
	            }),

	            new ol.control.Rotation({ target: 'statusbar'}),
	            new ol.control.Projection({
	                target: 'statusbar',
	                projections: ['EPSG:3857']
	            }),
	            search,

	            new ol.control.Alarm({target:'equipments'}),
	            new ol.control.Route({target:'equipments'}),
	            new ol.control.Equipments({target:'equipments'}),
	            new ol.control.RealTime({target:'equipments'})
	        ],
	        loadTilesWhileAnimating: true,
	        loadTilesWhileInteracting: true,
	        logo: false
	    });
	    //editor.getView().SetRotation(-14*Math.PI/180);
	    //地图加载时，操作
	    var showing = false;
	    $(document).ready(function() {
	    	    document.getElementById('queryform').addEventListener('submit', function (evt) {
	    	            evt.preventDefault();//阻止提交网页
	    	            //首先清除原有的所有要素
	    	            $('#tab-query').empty();
	    	            if (this.jika.checked) {
	    	            	//创建一级目录
	    	            	var root_div=$('#tab-query');
	    	            	var root_ul=$('<ul>').addClass('ce');
	    	            	
	    	            	var li=$('<li>');
	    	            	var a=$('<a>').attr('href','#').text("集卡");
	    	            	a.click(function(){

	    	            		 $(this).addClass("xz").parents().siblings().find("a").removeClass("xz");
	    	            				 $(this).parents().siblings().find(".er").hide(300);
	    	            				 $(this).siblings(".er").toggle(300);
	    	            				 $(this).parents().siblings().find(".ce > li > .er").hide().parents().siblings().find(".thr_nr").hide();
	    	            				 $(".thr_nr").hide();
	    	            	});
	    	            	$('<img>').addClass('more').attr('src','res/more.png').appendTo(a);
	    	            	a.appendTo(li);
	    	            	//创建二级目录
	    	            	var ul_1=$("<ul>").addClass('er');
	    	            	var li_1=$("<li>").addClass('e_li');
	    	            	$('<a>').attr("href","##").text("编号1").appendTo(li_1);
	    	            	li_1.appendTo(ul_1);
	    	            	
	    	            	ul_1.appendTo(li);
	    	            	
	    	            	
	    	            	li.prependTo(root_ul);
	    	            	$('<div>').addClass('clear').appendTo(root_ul);
	    	            	root_ul.appendTo(root_div);

	    	            	console.log("test");
	    	            	
	    	            }
	    	            console.log(this.start_time.value);
	    	            console.log(this.end_time.value);
	    	            console.log(this.jika.checked);
	    	            console.log(this.camera.checked);
	    	    		$('#querydlg').modal('hide');
	    	        });
	    	   
	    	//日期控件
	    	$('.form_datetime').datetimepicker({format: 'yyyy-mm-dd,hh:ii:ss', 
	    		  autoclose:true,
	    		  todayBtn:true,
	    		  pickerPosition:'bottom-right',
	    		  language:'zh-CN'});
	    	//传递参数调用后天方法
	    	
	    	//关闭右键功能
	        $(document).bind("contextmenu",function(e){
	               return false;
	           });
	        //menubar的第一层ul第一层li第一层a
	        $(document).on('click', '#menubar>ul>li>a', function(e) {
	            var elementToShow = $(this).attr('href');
	            if (!showing) {
	                showing = true;
	                setTimeout(function() {
	                    $(elementToShow).addClass('slide-out');
	                }, 100);
	            } else {
	                if (!$(elementToShow).hasClass('showing')) {
	                    $(elementToShow).addClass('showing');
	                }
	                if ($(elementToShow).hasClass('slide-out')) {
	                    $(elementToShow).removeClass('slide-out');
	                }
	            }
	            $(elementToShow).addClass('active');
	        });
	        //menubar ul li a
	        $(document).click(function(e) {
	            var tabs = $('#menubar>ul>li>a');
	            //选择除了.pinned以外的所有第一层div
	            var containers = $('#toolbar:not(.pinned)>div');
	            if ((!containers.is(e.target) && containers.has(e.target).length === 0)
	                && (!tabs.is(e.target) && tabs.has(e.target).length === 0)
	            ) {
	                containers.removeClass('slide-out');
	                containers.removeClass('showing');
	                containers.removeClass('active');
	                $('.application:not(.pinned-toolbar) #menubar>ul>li').removeClass('active');
	                showing = false;
	            }
	        });
	        //pin
	        $(document).on('click', 'a.pin', function(e) {
	            e.preventDefault();
	            $(this).toggleClass('active');
	            var target = $(this).attr('href');
	            $(target).toggleClass('pinned');
	            if (target == '#toolbar') { // activate the first
	                $('#menubar>ul>li>a[data-toggle=tab]').first().trigger('click');
	            }
	            $($(this).closest('.application')).toggleClass('pinned-' + $(this).attr('href').substr(1));
	            editor.updateSize(); // soo static
	        });
	        //tooltip
	        $('#toolbar [title], #map [title], #statusbar [title]').tooltip({
	            placement: 'auto bottom',
	            container: 'body'
	        });
	        //通过URL获取参数，并执行相应的操作
	  		var myurl=GetQueryString("minx");
			if(myurl !=null)
			{
			   var minx=GetQueryString('minx');
			   var miny=GetQueryString('miny');
			   var maxx=GetQueryString('maxx');
			   var maxy=GetQueryString('maxy');
			   editor.getView().fit([minx,miny,maxx,maxy]);
			}
	    });

	    //通过URL获取参数
		function GetQueryString(name)
		{
		     var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
		     var r = window.location.search.substr(1).match(reg);
		     if(r!=null)return  unescape(r[2]); return null;
		}

		// Select feature when click on the reference index
		// var select = new ol.interaction.Select({});
		editor.addInteraction(select);
		//On selected => show/hide popup
		select.getFeatures().on(['add'], function(e)
		{	
			var feature = e.element;
			if (feature.get('type')!==undefined) {
				var content = feature.getProperties();
				var table="<table class='table table-striped table-collapsed'>";
				Object.keys(content).forEach(function(key){
					if (key!=='geometry') {
						table+="<tr><td>"+key+"</td>"+"<td>"+feature.get(key)+"</td></tr>";
					}
				});
				table+="</table>";
				content += feature.get("type");
				popup.show(feature.getGeometry().getCoordinates(),table); 
			}
		})
		select.getFeatures().on(['remove'], function(e)
		{	popup.hide(); 
		})

		search.on('select', function(e)
		{	
			// select.getFeatures().clear();
			// select.getFeatures().push (e.search);
			var feature=e.search;
			var p = feature.getGeometry().getFirstCoordinate();
			if (feature.get('type')!==null) {
				editor.getView().animate({ center:p });
				var content = feature.getProperties();
				var table="<table class='ptable'>";
				Object.keys(content).forEach(function(key){
					if (key!=='geometry') {
						table+="<tr><td>"+key+"</td>"+"<td>"+feature.get(key)+"</td></tr>";
					}
				});
				table+="</table>";
				//content += feature.get("type");
				popup.show(p,table); 
			}
		});
		</script>
	</body>
</html>