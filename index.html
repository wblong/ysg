<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <title>洋山港</title>
    <!--jquery-->
    <script src="dist/jquery.min.js"></script>
    <<!--bootstrap-->
    <link rel="stylesheet" href="dist/bootstrap.min.css">
	<script src="dist/bootstrap.min.js"></script>
    <!--ol-->
    <link rel="stylesheet" href="dist/ol.min.css">
    <script src="dist/ol-debug.js"></script>
    <!--proj4-->
    <script src="dist/proj4.js"></script>
    <!--ol-ex-->
	<!--ol-ex-search-->
	<link rel="stylesheet"  href="dist/ex/control/searchcontrol.css">
	<script src="dist/ex/control/searchcontrol.js"></script>
	<script src="dist/ex/control/searchfeaturecontrol.js"></script>
	<!--ol-ex-overlay-->
	<link rel="stylesheet"  href="dist/ex/control/popupoverlay.css">
	<link rel="stylesheet"  href="dist/ex/control/popupoverlay.anim.css">
	<script src="dist/ex/control/popupoverlay.js"></script>
	<script src="dist/ex/control/videoPopupOverlay.js"></script>
    <!--ol-editor-->
    <link rel="stylesheet" href="dist/ol.editor.css">
	<script src="dist/ol.editor.js"></script>
	
    <!--custom css-->
    <link rel="stylesheet" type="text/css" href="dist/custom.css">
    <link rel="shortcut icon" href="favicon.ico">
    <script type="text/javascript" src="dist/styles.js"></script>
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
   
  </head>
  <body>
    <div class="application pinned-toolbar pinned-layermanager">
    	<!--菜单栏-->
		<div id="menubar" class="menubar">
        		<a href="#toolbar" class="pin active" title="Pin/unpin menubar"><i class="glyphicon glyphicon-pushpin"></i></a>
				<ul>
					<li class="active"><a href="#maptools" role="tab" data-toggle="tab">地图</a></li>
					<li><a href="#equipments" role="tab" data-toggle="tab">设备</a></li>
				</ul>
		</div>
		<!--工具条-->
		<div id="toolbar" class="toolbar tab-content pinned">
			<div id="maptools" class="tab-pane active showing"></div>
			<div id="equipments" class="tab-pane">
			</div>
		</div>
		<!--地图容器-->
		<div class="map-container">
			<!--图层管理器-->
			
			<div id="layermanager" class="layermanager pinned">
       		 	<div class="bar-title"><a href="#layermanager" class="pin active" title="Pin/unpin layer manager"><i class="glyphicon glyphicon-pushpin"></i></a> 图层管理</div>
    		</div>
    		<!--属性管理器-->
			<div id="attributemanager" class="attributemanager">
        		<div class="bar-title"><a href="#attributemanager" class="pin" title="Pin/unpin attribute manager"><i class="glyphicon glyphicon-pushpin"></i></a> 属性管理</div>
    		</div>
    		<!-- 地图 -->
			<div id="map" class="map" tabindex="-1" style="cursor:default"></div>
		</div>
		<!-- 状态栏 -->
     	<div id="statusbar" class="statusbar"></div>
    </div>
	<!-- 脚本 -->
	<script>
		/*
	 图层样式函数设置
	 */
	var styleFunction=function(feature,resolution){
		var zoom=editor.getView().getZoom();
		var style=null;
		var properties=feature.getProperties();
		if(properties.type===1){
			
			style=styles['car'];

		}
		else if(properties.type===2){
			style=styles['camera'];
		}
		else{
			style=styles['alarm'];
		}
		if (zoom===12) {
			return [styles['point']];
		}
		else{
			style.getImage().setScale(zoom/35);
			return [style];
		}
		
	};
		//选择
		var selectClick=new ol.interaction.Select({
			
		});
		//
		////加载图层
		var camera=new ol.layer.Vector({
			name:'相机',
			source:new ol.source.Vector({
				url:"data/camera.geojson",
				format:new ol.format.GeoJSON({
					featureProjection:'EPSG:3857'
				})

			}),
			style:styleFunction,
			wrapX: false
		});
		//加载图层
		var jika=new ol.layer.Vector({
			name:'集卡',
			source:new ol.source.Vector({
				url:"data/jika.geojson",
				format:new ol.format.GeoJSON()
			}),
			style:styleFunction,
			wrapX: false
		});
	     var attributeManager=new ol.control.AttributeManager({ target: 'attributemanager' });
	     //attributeManager.setMap(map);
	    // proj4.defs("EPSG:23700","+title=HD72 EOV +proj=somerc +lat_0=47.14439372222222 +lon_0=19.04857177777778 +k_0=0.99993 +x_0=650000 +y_0=200000 +ellps=GRS67 +towgs84=52.17,-71.82,-14.9,0,0,0,0 +units=m +no_defs");
	    var eov = new ol.proj.Projection({
	        code: 'EPSG:3857',
	        extent: [13582066.888853556, 3587359.445355572,
                    13585173.06488047, 3588705.080676691],
	        worldExtent: [73,3, 135, 53]
	    });
	   

	    //地图设置
	    //动态图层
	    var realTimeLayer=new ol.layer.Vector({
	    	name:'动态图层',
	    	source:new ol.source.Vector(),
	    	style:styleFunction
	    });
	    realTimeLayer.set('type','geomcollection');
	    realTimeLayer.set('id','realTimeLayerID');

	    //search
	    var search = new ol.control.SearchFeature(
		{	//target: $(".options").get(0),
			source: camera.getSource(),//设置查询的图层
			property: '编号'
		});

		// Popup overlay
		var popup = new ol.Overlay.Popup (
		{	popupClass: "default", //"tooltips", "warning" "black" "default", "tips", "shadow",
			closeBox: true,
			onclose: function(){ console.log("关闭窗口!"); },
			positioning: 'auto',
			autoPan: true,
			autoPanAnimation: { duration: 100 },
			id:'1'
		});
		// map
	    editor = new ol.Editor({
	    	overlays:[popup],

	        target: 'map',
	        view: new ol.View({
	            //projection: 'EPSG:4326',
	            extent: [13582065, 3587358,13585174, 3588706],
	            center: [13583806.359,3588119.431],
	            zoom: 14,
	            minZoom: 12,
                maxZoom: 23,
                rotation:-15*Math.PI/180.0
	        }),
	        layers: [
	            new ol.layer.Tile({
	                name: 'OpenStreetMap',
	                source: new ol.source.OSM()
	            }),
	        //     new ol.layer.Tile({
	        // 		visible: false,
	        // 		name:'ysg-tile',
	        // 		source: new ol.source.TileWMS({
	        //   			url: 'http://localhost:8080/geoserver/ysg/wms',
			      //     params: {'FORMAT': 'image/png', 
			      //              'VERSION': '1.1.1',
			      //              tiled: true,
			      //           STYLES: '',
			      //           LAYERS: 'ysg:jizhuangxiang',
			      //        tilesOrigin: 13582132.823772825 + "," + 3587341.8755370886
			      //     }
			      //   })
			      // }),
	            new ol.layer.Image({
	            	name:'洋山港-边界',
					source: new ol.source.ImageWMS({
						url: 'http://192.168.5.239:8080/geoserver/ysg/wms',
						params: {'LAYERS': 'ysg:bianjie1','VERSION':'1.1.0'},
						serverType: 'geoserver',
	         	 })
				}),
				 new ol.layer.Image({
	            	name:'洋山港-集装箱',
					source: new ol.source.ImageWMS({
						url: 'http://192.168.5.239:8080/geoserver/ysg/wms',
						params: {'LAYERS': 'ysg:jizhuangxiang','VERSION':'1.1.0'},
						serverType: 'geoserver',
	         	 })
				}),
				  new ol.layer.Image({
	            	name:'洋山港-道路',
					source: new ol.source.ImageWMS({
						url: 'http://192.168.5.239:8080/geoserver/ysg/wms',
						params: {'LAYERS': 'ysg:road','VERSION':'1.1.0'},
						serverType: 'geoserver',
	         	 })
				}),
				   new ol.layer.Image({
	            	name:'洋山港-设备',
					source: new ol.source.ImageWMS({
						url: 'http://192.168.5.239:8080/geoserver/ysg/wms',
						params: {'LAYERS': 'ysg:shebei','VERSION':'1.1.0'},
						serverType: 'geoserver',
	         	 })
				}),
				realTimeLayer,
				camera,
				jika
	        ],
	        //地图控件加载
	        
	        controls: [
	        	//new ol.control.Add({target:'ysgceshi',tipLabel:'相机标定'}),
	        	new ol.control.Exit(),
	        	new ol.control.FullScreen(),
	            new ol.control.Rotate(),
	            new ol.control.ScaleLine(),
	            new ol.control.ZoomSlider(),
	            new ol.control.Attribution({ collapsible: false }),
	            new ol.control.LayerManager({ target: 'layermanager' }),
	            attributeManager,
	            new ol.control.Zoom({ target: 'maptools',zoomOutLabel:'', zoomInTipLabel:'放大',zoomOutTipLabel:'缩小' }),
	            new ol.control.ZoomHistory({ target: 'maptools' , backTipLabel:'向前',nextTipLabel:'向后'}), 
	            new ol.control.ZoomToExtent({ target: 'maptools', label: ' ',tipLabel:'全局' ,extent: eov.getExtent()}),
	            new ol.control.ZoomToSelection({ target: 'maptools' }),
	            new ol.control.SelectionControls({ target: 'maptools' }),
	            new ol.control.Measure({ target: 'maptools' }),
	            new ol.control.Message({ target: 'statusbar' }),
	            new ol.control.MousePosition({
	                target: 'statusbar',
	                className: 'ol-mouse-position ol-control ol-unselectable',
	                coordinateFormat: ol.coordinate.createStringXY(3)
	            }),
	            new ol.control.Rotation({ target: 'statusbar'}),
	            new ol.control.Projection({
	                target: 'statusbar',
	                projections: ['EPSG:3857']
	            }),
	            search,
	            new ol.control.Alarm({target:'equipments'}),
	            new ol.control.Route({target:'equipments'})
	        ],
	        loadTilesWhileAnimating: true,
	        loadTilesWhileInteracting: true,
	        logo: false
	    });
	    //editor.getView().SetRotation(-14*Math.PI/180);
	    //地图加载时，操作
	    var showing = false;
	    $(document).ready(function () {
	        
	        $(document).on('click', '#menubar>ul>li>a', function(e) {
	            var elementToShow = $(this).attr('href');
	            if (!showing) {
	                showing = true;
	                setTimeout(function() {
	                    $(elementToShow).addClass('slide-out');
	                }, 100);
	            } else {
	                if (!$(elementToShow).hasClass('showing')) {
	                    $(elementToShow).addClass('showing');
	                }
	                if ($(elementToShow).hasClass('slide-out')) {
	                    $(elementToShow).removeClass('slide-out');
	                }
	            }
	            $(elementToShow).addClass('active');
	        });

	        $(document).click(function(e) {
	            var tabs = $('#menubar>ul>li>a');
	            var containers = $('#toolbar:not(.pinned)>div');
	            if ((!containers.is(e.target) && containers.has(e.target).length === 0)
	                && (!tabs.is(e.target) && tabs.has(e.target).length === 0)
	            ) {
	                containers.removeClass('slide-out');
	                containers.removeClass('showing');
	                containers.removeClass('active');
	                $('.application:not(.pinned-toolbar) #menubar>ul>li').removeClass('active');
	                showing = false;
	            }
	        });

	        $(document).on('click', 'a.pin', function(e) {
	            e.preventDefault();
	            $(this).toggleClass('active');
	            var target = $(this).attr('href');
	            $(target).toggleClass('pinned');
	            if (target == '#toolbar') { // activate the first
	                $('#menubar>ul>li>a[data-toggle=tab]').first().trigger('click');
	            }
	            $($(this).closest('.application')).toggleClass('pinned-' + $(this).attr('href').substr(1));
	            editor.updateSize(); // soo static
	        });

	        $('#startscreen a[href=#back]').on('click', function(e){
	            e.preventDefault();
	            $('#startscreen').removeClass('active');
	        });

	        $('#toolbar [title], #map [title], #statusbar [title]').tooltip({
	            placement: 'auto bottom',
	            container: 'body'
	        });
	        //通过URL获取参数，并执行相应的操作
	  		var myurl=GetQueryString("minx");
			if(myurl !=null)
			{
			   var minx=GetQueryString('minx');
			   var miny=GetQueryString('miny');
			   var maxx=GetQueryString('maxx');
			   var maxy=GetQueryString('maxy');
			   editor.getView().fit([minx,miny,maxx,maxy]);
			}
	    });

	    //通过URL获取参数
		function GetQueryString(name)
		{
		     var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
		     var r = window.location.search.substr(1).match(reg);
		     if(r!=null)return  unescape(r[2]); return null;
		}

		// Select feature when click on the reference index
		var select = new ol.interaction.Select({});
		editor.addInteraction(select);
		//On selected => show/hide popup
		select.getFeatures().on(['add'], function(e)
		{	
			var feature = e.element;
			var content = feature.getProperties();
			var table="<table class='ptable'>";
			Object.keys(content).forEach(function(key){
				if (key!=='geometry') {
					table+="<tr><td>"+key+"</td>"+"<td>"+feature.get(key)+"</td></tr>";
				}
			});
			table+="</table>";
			content += feature.get("type");
			popup.show(feature.getGeometry().getCoordinates(),table); 
		})
		select.getFeatures().on(['remove'], function(e)
		{	popup.hide(); 
		})

		search.on('select', function(e)
		{	
			// select.getFeatures().clear();
			// select.getFeatures().push (e.search);
			var feature=e.search;
			var p = feature.getGeometry().getFirstCoordinate();
			editor.getView().animate({ center:p });
			var content = feature.getProperties();
			var table="<table class='ptable'>";
			Object.keys(content).forEach(function(key){
				if (key!=='geometry') {
					table+="<tr><td>"+key+"</td>"+"<td>"+feature.get(key)+"</td></tr>";
				}
			});
			table+="</table>";
			//content += feature.get("type");
			popup.show(feature.getGeometry().getCoordinates(),table); 

		});
		</script>
	</body>
</html>